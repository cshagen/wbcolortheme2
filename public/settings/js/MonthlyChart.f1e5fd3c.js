"use strict";(self["webpackChunkopenwb_ui_settings"]=self["webpackChunkopenwb_ui_settings"]||[]).push([[4140],{8395:function(e,t,a){a.r(t),a.d(t,{default:function(){return w}});var r=a(6252),o=a(3577);const n={class:"monthlyChart"},s={name:"monthlyChartForm"},i={class:"row justify-content-center"},l={key:1},c={key:1};function p(e,t,a,p,h,d){const m=(0,r.up)("openwb-base-text-input"),u=(0,r.up)("openwb-base-click-button"),b=(0,r.up)("openwb-base-card"),y=(0,r.up)("openwb-base-alert"),g=(0,r.up)("Line"),w=(0,r.up)("openwb-base-heading");return(0,r.wg)(),(0,r.iD)("div",n,[(0,r._)("form",s,[(0,r.Wm)(b,{title:"Filter",collapsible:!0,collapsed:!1},{footer:(0,r.w5)((()=>[(0,r._)("div",i,[(0,r.Wm)(u,{class:"col-4 btn-success",onClick:t[1]||(t[1]=e=>d.requestMonthlyChart())},{default:(0,r.w5)((()=>[(0,r.Uk)(" Daten anfordern ")])),_:1})])])),default:(0,r.w5)((()=>[(0,r.Wm)(m,{title:"Monat",subtype:"month",min:"2018-01",max:h.currentMonth,modelValue:d.monthlyChartDate,"onUpdate:modelValue":t[0]||(t[0]=e=>d.monthlyChartDate=e)},null,8,["max","modelValue"])])),_:1}),d.chartDataRead?((0,r.wg)(),(0,r.iD)("div",l,[d.chartDataHasEntries?((0,r.wg)(),(0,r.iD)("div",c,[(0,r.Wm)(b,{title:"Diagramm",collapsible:!0,collapsed:!1},{default:(0,r.w5)((()=>[(0,r.Wm)(g,{chartData:d.chartData,chartOptions:h.chartOptions},null,8,["chartData","chartOptions"])])),_:1}),(0,r.Wm)(b,{title:"Summen",collapsible:!0,collapsed:!0},{default:(0,r.w5)((()=>[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(d.chartTotals,((t,a)=>((0,r.wg)(),(0,r.j4)(b,{key:a,title:d.getTotalsLabel(a),collapsible:!0,collapsed:!0,subtype:d.getCardSubtype(a)},{default:(0,r.w5)((()=>[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(t,((t,n)=>((0,r.wg)(),(0,r.iD)("div",{key:n},[(0,r.Wm)(w,null,{default:(0,r.w5)((()=>[(0,r.Uk)((0,o.zw)(d.getTotalsLabel(a,n)),1)])),_:2},1024),((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(t,((t,o)=>((0,r.wg)(),(0,r.iD)("div",{key:o},[(0,r.Wm)(m,{title:d.getTotalsLabel(a,n,o),readonly:"",class:"text-right",unit:"kWh","model-value":e.formatNumber(t/1e3,3)},null,8,["title","model-value"])])))),128))])))),128))])),_:2},1032,["title","subtype"])))),128))])),_:1})])):((0,r.wg)(),(0,r.j4)(y,{key:0,subtype:"info"},{default:(0,r.w5)((()=>[(0,r.Uk)(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ")])),_:1}))])):((0,r.wg)(),(0,r.j4)(y,{key:0,subtype:"info"},{default:(0,r.w5)((()=>[(0,r.Uk)(" Es wurden noch keine Daten abgerufen. ")])),_:1}))])])}a(6699);var h=a(7029),d=a(3764),m=(a(9555),a(840),a(4363)),u=a(6775);u.kL.register(u.u,u.De,u.ST,u.jn,u.od,u.f$,u.FB,u.Gu,m.ZP);var b={name:"OpenwbMonthlyChart",components:{Line:d.x1},mixins:[h.Z],emits:["sendCommand"],data(){return{mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/monthly/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentMonth:"",monthlyChartRequestData:{month:"",year:""},datasetTemplates:{"counter-power":{label:"Zähler",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,lineTension:.2,hidden:!1,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-power":{label:"PV",jsonKey:null,borderColor:"rgba(0, 255, 0, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-power":{label:"Speicher",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!1,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-power":{label:"Ladepunkt",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0},legend:{display:!0},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:0}},responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",time:{unit:"day",tooltipFormat:"D"},display:!0,title:{display:!0,text:"Tag"},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:31},grid:{}},y1:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Energie [kWh]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{monthlyChartDate:{get(){return this.monthlyChartRequestData.year+"-"+this.monthlyChartRequestData.month},set(e){let t=e.split("-");this.monthlyChartRequestData.year=t[0],this.monthlyChartRequestData.month=t[1]}},commandData(){return{month:this.monthlyChartRequestData.year+this.monthlyChartRequestData.month}},chartDataRead(){return void 0!=this.chartDataObject},chartDataHasEntries(){return this.chartDataObject.length>0},chartTotals(){if(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month]){if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month],"totals"))return this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month].totals;{var e={bat:{},counter:{},pv:{},cp:{}};const a=["imported","exported"],r=(t,r,o)=>{const n=o.split(".");a.includes(n[n.length-1])&&(Object.prototype.hasOwnProperty.call(e[n[0]],[n[1]])||(e[n[0]][n[1]]={}),e[n[0]][n[1]][n[2]]=Math.floor(r-t))},o=(e,t,a,r="")=>{for(var n in t)null!==t[n]&&"object"==typeof t[n]?o(e[n],t[n],a,r?r+"."+n:n):a.apply(this,[e[n],t[n],r?r+"."+n:n])};var t=this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month];const n=t[0],s=t[t.length-1];return o(n,s,r),e}}},chartDataObject(){if(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month]){var e=this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month];Object.prototype.hasOwnProperty.call(e,"entries")&&(console.debug("upgraded chart data received"),e=e.entries);var t=void 0,a=JSON.parse(JSON.stringify(e)).map((e=>{if(e.timestamp=1e3*e.timestamp,void 0!==t){const r=e.timestamp-t.timestamp;var a=["pv","counter","bat","cp"];return a.forEach((a=>{Object.entries(e[a]).forEach((([o,n])=>{t[a][o]&&Object.keys(n).forEach((()=>{switch(a){case"pv":Object.prototype.hasOwnProperty.call(e[a][o],"exported")&&Object.prototype.hasOwnProperty.call(t[a][o],"exported")&&(e[a][o].power=Math.floor((e[a][o].exported-t[a][o].exported)/(r/1e3/3600))/1e3);break;case"counter":Object.prototype.hasOwnProperty.call(e[a][o],"imported")&&Object.prototype.hasOwnProperty.call(t[a][o],"imported")&&Object.prototype.hasOwnProperty.call(e[a][o],"exported")&&Object.prototype.hasOwnProperty.call(t[a][o],"exported")&&(e[a][o].power=Math.floor((e[a][o].imported-t[a][o].imported-(e[a][o].exported-t[a][o].exported))/(r/1e3/3600))/1e3,e[a][o].powerImport=Math.max(0,e[a][o].power),e[a][o].powerExport=Math.min(0,e[a][o].power));break;case"bat":Object.prototype.hasOwnProperty.call(e[a][o],"imported")&&Object.prototype.hasOwnProperty.call(t[a][o],"imported")&&Object.prototype.hasOwnProperty.call(e[a][o],"exported")&&Object.prototype.hasOwnProperty.call(t[a][o],"exported")&&(e[a][o].power=Math.floor((e[a][o].imported-t[a][o].imported-(e[a][o].exported-t[a][o].exported))/(r/1e3/3600))/1e3,e[a][o].powerImport=Math.max(0,e[a][o].power),e[a][o].powerExport=Math.min(0,e[a][o].power));break;case"cp":Object.prototype.hasOwnProperty.call(e[a][o],"imported")&&Object.prototype.hasOwnProperty.call(t[a][o],"imported")&&(e[a][o].power=Math.floor((e[a][o].imported-t[a][o].imported)/(r/1e3/3600))/1e3);break}}))}))})),t=e,e}t=e}));return a.shift(),a}},chartData(){var e=["pv","counter","bat","cp","ev"];const t=this.chartDataObject[this.chartDataObject.length-1];return t&&e.forEach((e=>{Object.entries(t[e]).forEach((([t,a])=>{Object.keys(a).forEach((a=>{this.initDataset(e,t,a)}))}))})),this.chartDatasets}},methods:{getCardSubtype(e){switch(e){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";default:return"secondary"}},getDatasetHidden(e,t){return console.debug("getDatasetHidden",e,t),!1},getTotalsLabel(e,t,a){var r="*test*";if(!t&&!a){switch(e){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";default:console.warn("unknown group key:",e)}return"*"+e+"*"}if(t&&!a){if("all"==t)return"Summe";var o=t.match(/\d+$/),n="";switch(e){case"cp":n="openWB/chargepoint/"+o+"/config";break;case"ev":n="openWB/vehicle/"+o+"/name";break;default:n="openWB/system/device/+/component/"+o+"/config"}var s=Object.keys(this.getWildcardTopics(n))[0];if(s)switch(e){case"pv":return this.$store.state.mqtt[s].name;case"counter":return this.$store.state.mqtt[s].name;case"bat":return this.$store.state.mqtt[s].name;case"cp":return this.$store.state.mqtt[s].name;case"ev":return this.$store.state.mqtt[s];default:console.warn("unknown group key:",e)}else console.warn("topic not found for:",e,t);return"+"+e+"+"+t+"+"}if(t&&a){switch(e){case"bat":case"cp":switch(a){case"imported":return"Ladung";case"exported":return"Entladung";default:console.warn("unknown measurement key:",e,a)}break;case"counter":switch(a){case"imported":return"Bezug/Verbrauch";case"exported":return"Einspeisung/Erzeugung";default:console.warn("unknown measurement key:",e,a)}break;case"pv":switch(a){case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,a)}break;default:console.warn("unknown group key:",e)}return"*"+e+"+"+t+"+"+a+"*"}return r},getDatasetLabel(e,t,a,r){var o="*"+r;if("all"==t)switch(e){case"pv":o="PV (Summe)";break;case"bat":switch(o="Speicher",a){case"imported":o+=" (Ladung, Summe)";break;case"exported":o+=" (Entladung, Summe)";break;case"soc":o+=" SoC (Summe)";break;default:o+=" (Summe)"}break;case"cp":switch(o="Ladepunkte",a){case"imported":o+=" (Ladung, Summe)";break;case"exported":o+=" (Entladung, Summe)";break;case"soc":o+=" SoC (Summe)";break;default:o+=" (Summe)"}break}else{var n=t.match(/\d+$/),s="";switch(e){case"cp":s="openWB/chargepoint/"+n+"/config";break;case"ev":s="openWB/vehicle/"+n+"/name";break;default:s="openWB/system/device/+/component/"+n+"/config"}var i=Object.keys(this.getWildcardTopics(s))[0];switch(e){case"pv":o=this.$store.state.mqtt[i].name;break;case"counter":switch(o=this.$store.state.mqtt[i].name,a){case"imported":o+=" (Bezug)";break;case"exported":o+=" (Einspeisung)";break}break;case"bat":switch(o=this.$store.state.mqtt[i].name,a){case"imported":o+=" (Ladung)";break;case"exported":o+=" (Entladung)";break;case"soc":o+=" SoC";break}break;case"cp":switch(o=this.$store.state.mqtt[i].name,a){case"imported":o+=" (Ladung)";break;case"exported":o+=" (Entladung)";break;case"soc":o+=" SoC";break}break;case"ev":o=this.$store.state.mqtt[i];break}}return o},getDatasetIndex(e){let t=this.chartDatasets.datasets.findIndex((t=>t.jsonKey==e));if(-1!=t)return t},addDataset(e,t,a,r){console.debug("adding new dataset",e,t,a,r);var o=e+"-"+a;if(this.datasetTemplates[o]){var n=JSON.parse(JSON.stringify(this.datasetTemplates[o]));return n.parsing.yAxisKey=r,n.jsonKey=r,n.data=this.chartDataObject,n.label=this.getDatasetLabel(e,t,a,r),void 0!=n.labelSuffix&&(n.label=n.label+n.labelSuffix),"all"==t&&(n.hidden=!1),this.chartDatasets.datasets.push(n)-1}console.warn("no matching template found for: "+r+" with template: "+o)},initDataset(e,t,a){const r=["power","soc"],o=e+"."+t+"."+a;if(r.includes(a)){var n=this.getDatasetIndex(o);const r=this.getDatasetHidden(e,t);void 0!=n||r||(n=this.addDataset(e,t,a,o)),void 0!=n&&r&&(console.info("component hidden:",e,t,a,n),this.chartDatasets.datasets.splice(n,1))}},requestMonthlyChart(){let e=document.forms["monthlyChartForm"];e.reportValidity()?(this.chartDatasets.datasets=[],this.$emit("sendCommand",{command:"getMonthlyLog",data:this.commandData})):console.log("form invalid")}},mounted(){const e=new Date;this.currentMonth=this.monthlyChartDate=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0"),this.requestMonthlyChart()}},y=a(3744);const g=(0,y.Z)(b,[["render",p]]);var w=g}}]);
//# sourceMappingURL=MonthlyChart.f1e5fd3c.js.map