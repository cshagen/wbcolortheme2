"use strict";(self["webpackChunkopenwb_ui_settings"]=self["webpackChunkopenwb_ui_settings"]||[]).push([[5254],{7394:function(e,t,a){a.r(t),a.d(t,{default:function(){return w}});var r=a(6252),s=a(3577);const o={class:"dailyChart"},n={name:"dailyChartForm"},i={class:"row justify-content-center"},l={key:1},c={key:1};function d(e,t,a,d,p,u){const h=(0,r.up)("openwb-base-text-input"),m=(0,r.up)("openwb-base-click-button"),y=(0,r.up)("openwb-base-card"),b=(0,r.up)("openwb-base-alert"),g=(0,r.up)("Line"),w=(0,r.up)("openwb-base-heading");return(0,r.wg)(),(0,r.iD)("div",o,[(0,r._)("form",n,[(0,r.Wm)(y,{title:"Filter",collapsible:!0,collapsed:!1},{footer:(0,r.w5)((()=>[(0,r._)("div",i,[(0,r.Wm)(m,{class:"col-4 btn-success",onClick:t[1]||(t[1]=e=>u.requestDailyChart())},{default:(0,r.w5)((()=>[(0,r.Uk)(" Daten anfordern ")])),_:1})])])),default:(0,r.w5)((()=>[(0,r.Wm)(h,{title:"Datum",subtype:"date",min:"2018-01-01",max:p.currentDay,modelValue:u.dailyChartDate,"onUpdate:modelValue":t[0]||(t[0]=e=>u.dailyChartDate=e)},null,8,["max","modelValue"])])),_:1}),u.chartDataRead?((0,r.wg)(),(0,r.iD)("div",l,[u.chartDataHasEntries?((0,r.wg)(),(0,r.iD)("div",c,[(0,r.Wm)(y,{title:"Diagramm",collapsible:!0,collapsed:!1},{default:(0,r.w5)((()=>[(0,r.Wm)(g,{chartData:u.chartData,chartOptions:p.chartOptions},null,8,["chartData","chartOptions"])])),_:1}),(0,r.Wm)(y,{title:"Summen",collapsible:!0,collapsed:!0},{default:(0,r.w5)((()=>[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(u.chartTotals,((t,a)=>((0,r.wg)(),(0,r.j4)(y,{key:a,title:u.getTotalsLabel(a),collapsible:!0,collapsed:!0,subtype:u.getCardSubtype(a)},{default:(0,r.w5)((()=>[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(t,((t,o)=>((0,r.wg)(),(0,r.iD)("div",{key:o},[(0,r.Wm)(w,null,{default:(0,r.w5)((()=>[(0,r.Uk)((0,s.zw)(u.getTotalsLabel(a,o)),1)])),_:2},1024),((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(t,((t,s)=>((0,r.wg)(),(0,r.iD)("div",{key:s},[(0,r.Wm)(h,{title:u.getTotalsLabel(a,o,s),readonly:"",class:"text-right",unit:"kWh","model-value":e.formatNumber(t/1e3,3)},null,8,["title","model-value"])])))),128))])))),128))])),_:2},1032,["title","subtype"])))),128))])),_:1})])):((0,r.wg)(),(0,r.j4)(b,{key:0,subtype:"info"},{default:(0,r.w5)((()=>[(0,r.Uk)(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ")])),_:1}))])):((0,r.wg)(),(0,r.j4)(b,{key:0,subtype:"info"},{default:(0,r.w5)((()=>[(0,r.Uk)(" Es wurden noch keine Daten abgerufen. ")])),_:1}))])])}a(6699);var p=a(7029),u=a(3764),h=(a(9555),a(840),a(4363)),m=a(6775);m.kL.register(m.u,m.De,m.ST,m.jn,m.od,m.f$,m.FB,m.Gu,h.ZP);var y={name:"OpenwbDailyChart",components:{Line:u.x1},mixins:[p.Z],emits:["sendCommand"],data(){return{mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/daily/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentDay:"",dailyChartRequestData:{day:"",month:"",year:""},datasetTemplates:{"counter-power":{label:"Zähler",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,lineTension:.2,hidden:!1,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-power":{label:"PV",jsonKey:null,borderColor:"rgba(0, 255, 0, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-power":{label:"Speicher",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!1,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-soc":{label:"Speicher SoC",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,lineTension:.2,borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-power":{label:"Ladepunkt",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"ev-soc":{label:"Fahrzeug SoC",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,lineTension:.2,borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0},legend:{display:!0},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:0}},responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",time:{unit:"minute",tooltipFormat:"DD T"},display:!0,title:{display:!0,text:"Zeit"},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:15},grid:{}},y1:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Leistung [kW]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}},y2:{position:"right",type:"linear",display:"auto",suggestedMin:0,suggestedMax:100,title:{font:{size:12},display:!0,text:"SoC [%]"},grid:{display:!1},ticks:{font:{size:12},stepSize:10,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{dailyChartDate:{get(){return this.dailyChartRequestData.year+"-"+this.dailyChartRequestData.month+"-"+this.dailyChartRequestData.day},set(e){let t=e.split("-");this.dailyChartRequestData.year=t[0],this.dailyChartRequestData.month=t[1],this.dailyChartRequestData.day=t[2]}},commandData(){return{day:this.dailyChartRequestData.year+this.dailyChartRequestData.month+this.dailyChartRequestData.day}},chartDataRead(){return void 0!=this.chartDataObject},chartDataHasEntries(){return this.chartDataObject.length>0},chartTotals(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day],"totals"))return this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day].totals;{var e={bat:{},counter:{},pv:{},cp:{}};const a=["imported","exported"],r=(t,r,s)=>{const o=s.split(".");a.includes(o[o.length-1])&&(Object.prototype.hasOwnProperty.call(e[o[0]],[o[1]])||(e[o[0]][o[1]]={}),e[o[0]][o[1]][o[2]]=Math.floor(r-t))},s=(e,t,a,r="")=>{for(var o in t)null!==t[o]&&"object"==typeof t[o]?s(e[o],t[o],a,r?r+"."+o:o):a.apply(this,[e[o],t[o],r?r+"."+o:o])};var t=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];const o=t[0],n=t[t.length-1];return s(o,n,r),e}}},chartDataObject(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){var e=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];Object.prototype.hasOwnProperty.call(e,"entries")&&(console.debug("upgraded chart data received"),e=e.entries);var t=void 0,a=JSON.parse(JSON.stringify(e)).map((e=>{if(e.timestamp=1e3*e.timestamp,void 0!==t){const r=e.timestamp-t.timestamp;var a=["pv","counter","bat","cp"];return a.forEach((a=>{Object.entries(e[a]).forEach((([s,o])=>{t[a][s]&&Object.keys(o).forEach((()=>{switch(a){case"pv":Object.prototype.hasOwnProperty.call(e[a][s],"exported")&&Object.prototype.hasOwnProperty.call(t[a][s],"exported")&&(e[a][s].power=Math.floor((e[a][s].exported-t[a][s].exported)/(r/1e3/3600))/1e3);break;case"counter":Object.prototype.hasOwnProperty.call(e[a][s],"imported")&&Object.prototype.hasOwnProperty.call(t[a][s],"imported")&&Object.prototype.hasOwnProperty.call(e[a][s],"exported")&&Object.prototype.hasOwnProperty.call(t[a][s],"exported")&&(e[a][s].power=Math.floor((e[a][s].imported-t[a][s].imported-(e[a][s].exported-t[a][s].exported))/(r/1e3/3600))/1e3,e[a][s].powerImport=Math.max(0,e[a][s].power),e[a][s].powerExport=Math.min(0,e[a][s].power));break;case"bat":Object.prototype.hasOwnProperty.call(e[a][s],"imported")&&Object.prototype.hasOwnProperty.call(t[a][s],"imported")&&Object.prototype.hasOwnProperty.call(e[a][s],"exported")&&Object.prototype.hasOwnProperty.call(t[a][s],"exported")&&(e[a][s].power=Math.floor((e[a][s].imported-t[a][s].imported-(e[a][s].exported-t[a][s].exported))/(r/1e3/3600))/1e3,e[a][s].powerImport=Math.max(0,e[a][s].power),e[a][s].powerExport=Math.min(0,e[a][s].power));break;case"cp":Object.prototype.hasOwnProperty.call(e[a][s],"imported")&&Object.prototype.hasOwnProperty.call(t[a][s],"imported")&&(e[a][s].power=Math.floor((e[a][s].imported-t[a][s].imported)/(r/1e3/3600))/1e3);break}}))}))})),t=e,e}t=e}));return a.shift(),a}},chartData(){var e=["pv","counter","bat","cp","ev"];const t=this.chartDataObject[this.chartDataObject.length-1];return t&&e.forEach((e=>{Object.entries(t[e]).forEach((([t,a])=>{Object.keys(a).forEach((a=>{this.initDataset(e,t,a)}))}))})),this.chartDatasets}},methods:{getCardSubtype(e){switch(e){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";default:return"secondary"}},getDatasetHidden(e,t){return console.debug("getDatasetHidden",e,t),!1},getTotalsLabel(e,t,a){var r="*test*";if(!t&&!a){switch(e){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";default:console.warn("unknown group key:",e)}return"*"+e+"*"}if(t&&!a){if("all"==t)return"Summe";var s=t.match(/\d+$/),o="";switch(e){case"cp":o="openWB/chargepoint/"+s+"/config";break;case"ev":o="openWB/vehicle/"+s+"/name";break;default:o="openWB/system/device/+/component/"+s+"/config"}var n=Object.keys(this.getWildcardTopics(o))[0];if(n)switch(e){case"pv":return this.$store.state.mqtt[n].name;case"counter":return this.$store.state.mqtt[n].name;case"bat":return this.$store.state.mqtt[n].name;case"cp":return this.$store.state.mqtt[n].name;case"ev":return this.$store.state.mqtt[n];default:console.warn("unknown group key:",e)}else console.warn("topic not found for:",e,t);return"+"+e+"+"+t+"+"}if(t&&a){switch(e){case"bat":case"cp":switch(a){case"imported":return"Ladung";case"exported":return"Entladung";default:console.warn("unknown measurement key:",e,a)}break;case"counter":switch(a){case"imported":return"Bezug/Verbrauch";case"exported":return"Einspeisung/Erzeugung";default:console.warn("unknown measurement key:",e,a)}break;case"pv":switch(a){case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,a)}break;default:console.warn("unknown group key:",e)}return"*"+e+"+"+t+"+"+a+"*"}return r},getDatasetLabel(e,t,a,r){var s="*"+r;if("all"==t)switch(e){case"pv":s="PV (Summe)";break;case"bat":switch(s="Speicher",a){case"imported":s+=" (Ladung, Summe)";break;case"exported":s+=" (Entladung, Summe)";break;case"soc":s+=" SoC (Summe)";break;default:s+=" (Summe)"}break;case"cp":switch(s="Ladepunkte",a){case"imported":s+=" (Ladung, Summe)";break;case"exported":s+=" (Entladung, Summe)";break;case"soc":s+=" SoC (Summe)";break;default:s+=" (Summe)"}break}else{var o=t.match(/\d+$/),n="";switch(e){case"cp":n="openWB/chargepoint/"+o+"/config";break;case"ev":n="openWB/vehicle/"+o+"/name";break;default:n="openWB/system/device/+/component/"+o+"/config"}var i=Object.keys(this.getWildcardTopics(n))[0];switch(e){case"pv":s=this.$store.state.mqtt[i].name;break;case"counter":switch(s=this.$store.state.mqtt[i].name,a){case"imported":s+=" (Bezug)";break;case"exported":s+=" (Einspeisung)";break}break;case"bat":switch(s=this.$store.state.mqtt[i].name,a){case"imported":s+=" (Ladung)";break;case"exported":s+=" (Entladung)";break;case"soc":s+=" SoC";break}break;case"cp":switch(s=this.$store.state.mqtt[i].name,a){case"imported":s+=" (Ladung)";break;case"exported":s+=" (Entladung)";break;case"soc":s+=" SoC";break}break;case"ev":s=this.$store.state.mqtt[i];break}}return s},getDatasetIndex(e){let t=this.chartDatasets.datasets.findIndex((t=>t.jsonKey==e));if(-1!=t)return t},addDataset(e,t,a,r){console.debug("adding new dataset",e,t,a,r);var s=e+"-"+a;if(this.datasetTemplates[s]){var o=JSON.parse(JSON.stringify(this.datasetTemplates[s]));return o.parsing.yAxisKey=r,o.jsonKey=r,o.data=this.chartDataObject,o.label=this.getDatasetLabel(e,t,a,r),void 0!=o.labelSuffix&&(o.label=o.label+o.labelSuffix),"all"==t&&(o.hidden=!1),this.chartDatasets.datasets.push(o)-1}console.warn("no matching template found for: "+r+" with template: "+s)},initDataset(e,t,a){const r=["power","soc"],s=e+"."+t+"."+a;if(r.includes(a)){var o=this.getDatasetIndex(s);const r=this.getDatasetHidden(e,t);void 0!=o||r||(o=this.addDataset(e,t,a,s)),void 0!=o&&r&&(console.info("component hidden:",e,t,a,o),this.chartDatasets.datasets.splice(o,1))}},requestDailyChart(){let e=document.forms["dailyChartForm"];e.reportValidity()?(this.chartDatasets.datasets=[],this.$emit("sendCommand",{command:"getDailyLog",data:this.commandData})):console.log("form invalid")}},mounted(){const e=new Date;this.currentDay=this.dailyChartDate=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"),this.requestDailyChart()}},b=a(3744);const g=(0,b.Z)(y,[["render",d]]);var w=g}}]);
//# sourceMappingURL=DailyChart.f869b97c.js.map